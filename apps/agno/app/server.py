# –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ FastAPI –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
import fastapi
from fastapi import FastAPI  # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ FastAPI –¥–ª—è –≤–µ–±-API
from fastapi.middleware.cors import CORSMiddleware  # CORS middleware –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
from fastapi.responses import StreamingResponse  # –î–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
import uuid  # –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
from typing import Any  # –ü–æ–¥—Å–∫–∞–∑–∫–∏ —Ç–∏–ø–æ–≤ –¥–ª—è –ª—É—á—à–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∫–æ–¥–∞
import os  # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
import uvicorn  # ASGI —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π FastAPI
import asyncio  # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤–≤–æ–¥-–≤—ã–≤–æ–¥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–∏–∫–ª–æ–º —Å–æ–±—ã—Ç–∏–π
from openai import OpenAI  # –ö–ª–∏–µ–Ω—Ç OpenAI –¥–ª—è –≤—ã–∑–æ–≤–∞ LLM

# –ò–º–ø–æ—Ä—Ç WordStat –∞–≥–µ–Ω—Ç–∞ (Direct Mode - –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã API –±–µ–∑ MCP)
from .wordstat_agent_direct import wordstat_agent_direct as wordstat_agent

# –ò–º–ø–æ—Ä—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã —Å–æ–±—ã—Ç–∏–π –∏–∑ ag_ui.core –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π UI –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
from ag_ui.core import (
    RunAgentInput,  # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–≥–µ–Ω—Ç–∞
    StateSnapshotEvent,  # –°–æ–±—ã—Ç–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ UI
    EventType,  # –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
    RunStartedEvent,  # –°–æ–±—ã—Ç–∏–µ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É—é—â–µ–µ –æ –Ω–∞—á–∞–ª–µ —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞
    RunFinishedEvent,  # –°–æ–±—ã—Ç–∏–µ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É—é—â–µ–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞
    TextMessageStartEvent,  # –°–æ–±—ã—Ç–∏–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    TextMessageEndEvent,  # –°–æ–±—ã—Ç–∏–µ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    TextMessageContentEvent,  # –°–æ–±—ã—Ç–∏–µ –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
    ToolCallStartEvent,  # –°–æ–±—ã—Ç–∏–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤/—Ñ—É–Ω–∫—Ü–∏–π
    ToolCallEndEvent,  # –°–æ–±—ã—Ç–∏–µ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤/—Ñ—É–Ω–∫—Ü–∏–π
    ToolCallArgsEvent,  # –°–æ–±—ã—Ç–∏–µ –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    StateDeltaEvent,  # –°–æ–±—ã—Ç–∏–µ –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è
)

# –ò–º–ø–æ—Ä—Ç –∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
from ag_ui.encoder import EventEncoder  # –ö–æ–¥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–º

from typing import List  # –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Ç–∏–ø–∞ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤

# –ò–º–ø–æ—Ä—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
from .auth import get_user_from_request  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∑–∞–ø—Ä–æ—Å–∞

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è FastAPI
app = FastAPI(title="Ruelectronics Support Agent API", description="API –∞–≥–µ–Ω—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ Ruelectronics")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS middleware –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã)
    allow_credentials=True,  # –†–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∫—É–∫–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    allow_methods=["*"],  # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ HTTP –º–µ—Ç–æ–¥—ã
    allow_headers=["*"],  # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
)

# –û–°–ù–û–í–ù–û–ô ENDPOINT API: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∞–≥–µ–Ω—Ç–∞–º
# –≠—Ç–æ—Ç endpoint –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏ —Å—Ç—Ä–∏–º–∏—Ç –æ—Ç–≤–µ—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
@app.post("/agno-agent")
async def agno_agent_handler(input_data: RunAgentInput, request: fastapi.Request):
    """
    –ì–ª–∞–≤–Ω—ã–π endpoint –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏.
    –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WordStat –∞–≥–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–∏–º–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã.
    """
    try:
        # –ê–°–ò–ù–•–†–û–ù–ù–´–ô –ì–ï–ù–ï–†–ê–¢–û–†: –°—Ç—Ä–∏–º–∏—Ç —Å–æ–±—ã—Ç–∏—è –∫–ª–∏–µ–Ω—Ç—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫ —Å–æ–±—ã—Ç–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É
        async def event_generator():
            # –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Å–æ–±—ã—Ç–∏–π
            encoder = EventEncoder()  # –ö–æ–¥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏
            event_queue = asyncio.Queue()  # –û—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –∏–∑ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞

            # –®–∞–≥ 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ callback —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π
            # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —à–∞–≥–∞–º–∏ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ UI
            def emit_event(event):
                event_queue.put_nowait(event)  # –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

            # –®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            message_id = str(uuid.uuid4())

            # –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è "–∑–∞–ø—É—Å–∫ –Ω–∞—á–∞—Ç" –∫–ª–∏–µ–Ω—Ç—É
            # –°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç UI, —á—Ç–æ –∞–≥–µ–Ω—Ç –Ω–∞—á–∞–ª –æ–±—Ä–∞–±–æ—Ç–∫—É
            yield encoder.encode(
                RunStartedEvent(
                    type=EventType.RUN_STARTED,
                    thread_id=getattr(input_data, "thread_id", None) or str(uuid.uuid4()),
                    run_id=getattr(input_data, "run_id", None) or str(uuid.uuid4()),
                )
            )

            # –®–∞–≥ 5: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–Ω–∏–º–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É
            # –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            yield encoder.encode(
                StateSnapshotEvent(
                    type=EventType.STATE_SNAPSHOT,
                    snapshot={
                        "messages": getattr(input_data, "messages", []) or [],
                        "state": getattr(input_data, "state", {}) or {},
                        "tool_logs": [],
                    },
                )
            )
            
            # –®–∞–≥ 6: (–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∏–∂–µ) –ù–∞—á–∞–ª–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
            # –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∞–≥–µ–Ω—Ç –∑–∞–∫–æ–Ω—á–∏—Ç —ç–º–∏—Ç–∏—Ç—å STATE_DELTA —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã
            # –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ –ø–æ—Ä—è–¥–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ CopilotKit

            # –®–∞–≥ 7: –í—ã–∑–æ–≤ –Ω–∞—à–µ–≥–æ –∞–≥–µ–Ω—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            response_text = ""
            try:
                # –°–æ–∑–¥–∞–µ–º mock –æ–±—ä–µ–∫—Ç step_input –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∞–≥–µ–Ω—Ç–æ–º
                class MockStepInput:
                    def __init__(self, input_data):
                        self.additional_data = {
                            'messages': getattr(input_data, "messages", []) or [],
                            'tool_logs': [],
                            'emit_event': emit_event
                        }

                # –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                messages = getattr(input_data, "messages", []) or []
                if not messages:
                    # –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    class MockMessage:
                        def __init__(self, role, content):
                            self.role = role
                            self.content = content

                    messages.append(MockMessage("user", "–ü—Ä–∏–≤–µ—Ç! –ü–æ–º–æ–≥–∏—Ç–µ –º–Ω–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."))

                mock_step_input = MockStepInput(input_data)
                mock_step_input.additional_data['messages'] = messages
                # –í—ã—Ç—è–≥–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –≤ –∞–≥–µ–Ω—Ç–∞
                try:
                    user_info = get_user_from_request(request)
                    if user_info:
                        mock_step_input.additional_data['user'] = {
                            'id': user_info.user_id,
                            'username': user_info.username,
                            'first_name': getattr(user_info, 'first_name', None),
                            'last_name': getattr(user_info, 'last_name', None),
                        }
                except Exception as e:
                    print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∑–∞–ø—Ä–æ—Å–∞: {e}")

                # –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º WordStat –∞–≥–µ–Ω—Ç
                selected_agent = wordstat_agent
                print("ü§ñ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WordStat –∞–≥–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤")

                # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≥–µ–Ω—Ç–∞ –∫–∞–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–¥–∞—á—É –∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å—Ç—Ä–∏–º–∏–º —Å–æ–±—ã—Ç–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                agent_task = asyncio.create_task(selected_agent.process_query(mock_step_input))

                # –ü–æ–∫–∞ –∞–≥–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏—è, –ø—Ä–∏—Ö–æ–¥—è—â–∏–µ —á–µ—Ä–µ–∑ emit_event
                while not agent_task.done() or not event_queue.empty():
                    try:
                        event = await asyncio.wait_for(event_queue.get(), timeout=0.1)
                        yield encoder.encode(event)
                    except asyncio.TimeoutError:
                        # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∂–¥–∞—Ç—å, –µ—Å–ª–∏ –∞–≥–µ–Ω—Ç –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ –µ—Å—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏
                        if agent_task.done() and event_queue.empty():
                            break
                        continue

                # –î–æ–∂–∏–¥–∞–µ–º—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–≥–µ–Ω—Ç–∞
                result = await agent_task

                # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞
                if result and 'messages' in result and result['messages']:
                    last_message = result['messages'][-1]
                    if hasattr(last_message, 'content'):
                        response_text = last_message.content or ""
                    elif isinstance(last_message, dict) and 'content' in last_message:
                        response_text = last_message['content'] or ""

                # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
                if not response_text:
                    response_text = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø Agno-–∞–≥–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ü—Ä–æ–≤–µ—Ä—å –∑–∞–ø—Ä–æ—Å –∫—É–ø–∏—Ç—å –ø—Ä–∏–ø–æ–π' –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–π—Ç–µ—Å—å."

            except Exception as e:
                # –õ–æ–≥ –∏ graceful-—Ñ–æ–ª–ª–±–µ–∫, —á—Ç–æ–±—ã UI –Ω–µ –ª–æ–º–∞–ª—Å—è
                import traceback
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ WordStat –∞–≥–µ–Ω—Ç–∞: {e}")
                print(traceback.format_exc())
                response_text = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å WordStat API. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."

            # –®–∞–≥ 9: –†–∞–∑–±–∏–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —á–∞—Å—Ç–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∏
            # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –Ω–∞ 50 —á–∞—Å—Ç–µ–π –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
            n_parts = 50
            part_length = max(1, len(response_text) // n_parts)  # –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–∏–Ω–∏–º—É–º 1 —Å–∏–º–≤–æ–ª –Ω–∞ —á–∞—Å—Ç—å
            parts = [
                response_text[i : i + part_length]
                for i in range(0, len(response_text), part_length)
            ]
            
            # –®–∞–≥ 10: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–∞–π–Ω–µ–≥–æ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —á–∞—Å—Ç–µ–π
            if len(parts) > n_parts:
                parts = parts[: n_parts - 1] + ["".join(parts[n_parts - 1 :])]
            
            # –®–∞–≥ 11: –ù–∞—á–∞–ª–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å—Ç—Ä–∏–º –∫–∞–∂–¥–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
            # –°–Ω–∞—á–∞–ª–∞ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º UI –æ –Ω–∞—á–∞–ª–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏
            yield encoder.encode(
                TextMessageStartEvent(
                    type=EventType.TEXT_MESSAGE_START,
                    message_id=message_id,
                    role="assistant",
                )
            )
            # –¢–µ–ø–µ—Ä—å —Å—Ç—Ä–∏–º–∏–º –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∏
            # –®–∞–≥ 11: –°—Ç—Ä–∏–º –∫–∞–∂–¥–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∏
            for part in parts:
                yield encoder.encode(
                    TextMessageContentEvent(
                        type=EventType.TEXT_MESSAGE_CONTENT,
                        message_id=message_id,
                        delta=part,  # –§—Ä–∞–≥–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    )
                )
                await asyncio.sleep(0.03)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∏

            # –®–∞–≥ 12: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            # –°–∏–≥–Ω–∞–ª UI, —á—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            yield encoder.encode(
                TextMessageEndEvent(
                    type=EventType.TEXT_MESSAGE_END,
                    message_id=message_id,
                )
            )

            # –®–∞–≥ 13: –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –ª–æ–≥–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ UI
            yield encoder.encode(
                StateDeltaEvent(
                    type=EventType.STATE_DELTA,
                    delta=[{"op": "replace", "path": "/tool_logs", "value": []}],
                )
            )

            # –®–∞–≥ 14: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è "–∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω"
            # –°–∏–≥–Ω–∞–ª –∫–ª–∏–µ–Ω—Ç—É, —á—Ç–æ –≤–µ—Å—å –∑–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω
            yield encoder.encode(
                RunFinishedEvent(
                    type=EventType.RUN_FINISHED,
                    thread_id=getattr(input_data, "thread_id", None) or str(uuid.uuid4()),
                    run_id=getattr(input_data, "run_id", None) or str(uuid.uuid4()),
                )
            )


        # –®–∞–≥ 15: –í–æ–∑–≤—Ä–∞—Ç —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É
        # FastAPI –±—É–¥–µ—Ç —Å—Ç—Ä–∏–º–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –∫–∞–∫ Server-Sent Events (SSE)
        return StreamingResponse(event_generator(), media_type="text/event-stream")

    except Exception as e:
        # –®–∞–≥ 16: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –æ—à–∏–±–æ–∫ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")  # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        
        async def error_generator():
            try:
                error_encoder = EventEncoder()
                yield error_encoder.encode(
                    TextMessageContentEvent(
                        type=EventType.TEXT_MESSAGE_CONTENT,
                        message_id=str(uuid.uuid4()),
                        delta="–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                    )
                )
            except:
                yield "data: –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\n\n"
        
        return StreamingResponse(error_generator(), media_type="text/event-stream")


# ENDPOINT –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –°–û–°–¢–û–Ø–ù–ò–Ø: –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
@app.get("/health")
async def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞."""
    return {
        "status": "ok",
        "message": "–°–µ—Ä–≤–µ—Ä Agno –∞–≥–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ",
        "available_agents": {
            "electronics": "–ê–≥–µ–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Ruelectronics",
            "wordstat": "–ê–≥–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ WordStat"
        },
        "company": "Ruelectronics + WordStat Integration"
    }


# ENDPOINT –î–õ–Ø –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@app.get("/user")
async def get_current_user(request: fastapi.Request):
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞."""
    try:
        user_info = get_user_from_request(request)
        if user_info:
            return {
                "authenticated": True,
                "user": {
                    "id": user_info.user_id,
                    "username": user_info.username
                }
            }
        else:
            return {"authenticated": False, "user": None}
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return {"authenticated": False, "error": str(e)}


# –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–£–°–ö–ê –°–ï–†–í–ï–†–ê: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ FastAPI
def main():
    """–ó–∞–ø—É—Å–∫ uvicorn —Å–µ—Ä–≤–µ—Ä–∞."""
    # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8000
    port = int(os.getenv("PORT", "8000"))
    
    # –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ uvicorn ASGI —Å–µ—Ä–≤–µ—Ä–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
    uvicorn.run(
        "app.server:app",  # –°—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–¥—É–ª—å:–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        host="0.0.0.0",  # –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
        port=port,  # –ù–æ–º–µ—Ä –ø–æ—Ä—Ç–∞
        reload=True,  # –ê–≤—Ç–æ-–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞ (—Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
    )


# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞
if __name__ == "__main__":
    main()
